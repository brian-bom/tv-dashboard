<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tabela Semanal</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121823; --text:#e6eef9; --muted:#90a3bd; --line:#243142;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 8px}
  .note{color:var(--muted);font-size:13px}
  .card{background:#121823;border:1px solid var(--line);border-radius:14px;padding:16px}
  .toolbar{display:flex;align-items:center;gap:10px;margin:6px 0 16px}
  .btn{cursor:pointer;border:1px solid var(--line);background:#142033;color:#dbe8ff;border-radius:10px;padding:8px 12px}
  .grid{
    width:100%;
    overflow:auto;
  }
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px}
  th{background:#0f1520;color:#bcd0ea;text-align:center}
  td{vertical-align:top;background:#0c131d}
  .cell-header{display:flex;gap:10px;font-weight:600;color:#bcd0ea}
  .row-pair:nth-child(even) td{background:#0e1622}
  .cliente{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  .valor{float:right}
  tfoot td{background:#0f1520;font-weight:700}
  .total-title{text-align:center}
  .subtotal{
    margin-top:10px;display:flex;align-items:center;gap:14px;
    background:#0f1520;border:1px solid var(--line);border-radius:12px;padding:10px 12px
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Tabela semanal</h1>
    <div class="note" id="rangeInfo"></div>

    <div class="toolbar">
      <button class="btn" id="prevBtn">‚óÄ Semana anterior</button>
      <button class="btn" id="nextBtn">Pr√≥xima semana ‚ñ∂</button>
      <span class="note">Clique nos bot√µes para navegar.</span>
    </div>

    <div class="card">
      <div class="grid">
        <table id="tbl">
          <thead>
            <tr id="hdr"></tr>
            <tr id="subhdr"></tr>
          </thead>
          <tbody id="body"></tbody>
          <tfoot id="foot"></tfoot>
        </table>
      </div>

      <div class="subtotal">
        <strong>Subtotal da semana:</strong>
        <span id="subtotal"></span>
      </div>
    </div>
  </div>

<script>
  // estado de navega√ß√£o por semanas usando ?date=YYYY-MM-DD
  let currentDate = new Date(); // base para a semana

  const fmtBRL = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);

  function weekLabel(startISO, endISO){
    const s = new Date(startISO);
    const e = new Date(new Date(endISO).getTime() - 1); // at√© domingo 23:59:59
    const f = (d)=> d.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    return `(${f(s)} a ${f(e)})`;
  }

  async function load(){
    const yyyy = currentDate.getFullYear();
    const mm = String(currentDate.getMonth()+1).padStart(2,'0');
    const dd = String(currentDate.getDate()).padStart(2,'0');
    const r = await fetch(`/api/week?date=${yyyy}-${mm}-${dd}`);
    const data = await r.json();

    const order = data.order; // ["segunda",...,"domingo"]
    const days = data.days;

    // Cabe√ßalho
    const hdr = document.getElementById('hdr');
    const sub = document.getElementById('subhdr');
    hdr.innerHTML = ''; sub.innerHTML = '';
    for (const k of order){
      const title = cap(k === 'terca' ? 'ter√ßa' : (k === 'sabado' ? 's√°bado' : k));
      const th = document.createElement('th');
      th.textContent = title;
      hdr.appendChild(th);

      const th2 = document.createElement('th');
      th2.innerHTML = `<div class="cell-header"><span style="flex:1">Cliente</span><span>Valor</span></div>`;
      sub.appendChild(th2);
    }

    // Corpo (equalizar n√∫mero de linhas nas colunas)
    const body = document.getElementById('body');
    body.innerHTML = '';
    const heights = order.map(k => (days[k]?.items?.length || 0));
    const maxRows = Math.max(10, ...heights); // garante altura confort√°vel

    for (let i = 0; i < maxRows; i++){
      const tr = document.createElement('tr');
      tr.className = 'row-pair';
      for (const k of order){
        const td = document.createElement('td');
        const item = (days[k]?.items || [])[i];
        if (item){
          td.innerHTML = `
            <span class="cliente">${escapeHtml(item.client || '')}</span>
            <span class="valor">${fmtBRL(item.amount || 0)}</span>
          `;
        }else{
          td.innerHTML = '&nbsp;';
        }
        tr.appendChild(td);
      }
      body.appendChild(tr);
    }

    // Rodap√©: Totais do dia
    const foot = document.getElementById('foot');
    const trTot = document.createElement('tr');
    for (const k of order){
      const td = document.createElement('td');
      td.className = 'total-title';
      td.textContent = `Total: ${fmtBRL(days[k]?.total || 0)}`;
      trTot.appendChild(td);
    }
    foot.innerHTML = '';
    foot.appendChild(trTot);

    // Subtotal da semana
    document.getElementById('subtotal').textContent = fmtBRL(data.subtotal || 0);
    document.getElementById('rangeInfo').textContent =
      'Semana ' + weekLabel(data.range.startISO, data.range.endISO);
  }

  // util para evitar HTML injection ao preencher cliente
  function escapeHtml(str){
    return (str||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // Navega√ß√£o por semanas
  function shiftWeek(delta){
    const d = new Date(currentDate);
    d.setDate(d.getDate() + delta*7);
    currentDate = d;
    load();
  }

  document.getElementById('prevBtn').onclick = () => shiftWeek(-1);
  document.getElementById('nextBtn').onclick = () => shiftWeek(+1);

  load();

  setInterval(async () => {
  console.log("üîÑ Atualizando tabela semanal...");
  await load();
}, 15000);

</script>
</body>
</html>
